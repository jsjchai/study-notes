# 数据模型与查询语言

## 关系模型与文档模型
### 关系数据库
  * 1对1
  * 1对多
  * 多对多
### ACID事务特性
  * 原子性
  * 一致性
  * 隔离性
  * 可持久性
## NoSQL 
> 不仅仅是 SQL（Not Only SQL）
### 原因
* 需要比关系数据库更好的可伸缩性，包括非常大的数据集或非常高的写入吞吐量
* 相比商业数据库产品，免费和开源软件更受偏爱
* 关系模型不能很好地支持一些特殊的查询操作
* 对于关系模型的限制性，渴望一种更具多动态性与表现力的数据模型
### 对象关系不匹配
* sql兼容性问题
   * 如果数据存储在关系表中，那么应用程序代码中的对象和表，行，列的数据库模型之间需要一个笨拙的转化层
      * ORM框架
### 文档数据库
* 层次模型（hierarchical model）
  * 很难应对多对多的关系，并且不支持连接
  * 文件目录
  * 很好支持了一对多的关系，但是很难支持多对多关系
* 提出了各种不同的解决方案来解决层次模型的局限性
  * 网络模型(不常用）
    * 网状模型由一个称为数据系统语言会议（CODASYL）的委员会进行了标准化，并被数个不同的数据库厂商实现；它也被称为 CODASYL 模型
    * 在层次模型的树结构中，每条记录只有一个父节点
    * 在网络模式中，每条记录可能有多个父节点
    * 查询和更新数据库的代码变得复杂不灵活
  * 关系模型
    * sql
    * 一个 关系（表） 只是一个 元组（行） 的集合
    * 在关系数据库中，查询优化器自动决定查询的哪些部分以哪个顺序执行，以及使用哪些索引
    * 只需构建一次查询优化器，随后使用该数据库的所有应用程序都可以从中受益
* 与文档数据库相比
  * 文档数据库是某种方式的层次模型
  * 在其父记录中存储嵌套记录
  * 在表示多对一和多对多的关系时，关系数据库和文档数据库并没有根本的不同
  * 相关项目都被一个唯一的标识符引用，这个标识符在关系模型中被称为外键，在文档模型中称为文档引用
  * 文档数据模型-架构灵活性，因局部性而拥有更好的性能
  * 文档数据模型-更接近于应用程序使用的数据结构
#### 哪种数据模型更有助于简化应用代码
*  文档模型-应用程序中的数据具有类似文档的结构（即一对多关系树，通常一次加载整个树）
*  文档的结构分解成多个表（文档模型-关系模型）
     *  导致繁琐的模式和不必要的复杂的应用程序代码
*  文档模型有一定的局限性
     *  不能直接引用文档中的嵌套的项目
*  文档数据库不支持关联查询
     *  通过反规范化来消除对连接的需求
     *  需要应用程序代码来做额外的工作以确保数据一致性
     *  向数据库发出多个请求，导致查询逻辑复杂
*  图形模型-高度关联的数据
*  文档模型中的模式灵活性
    *  json格式
       *  无法模式验证（字段类型校验），xml可以
    * 文档数据库有时称为 无模式（schemaless）
#### 模式分类
* 读时模式（schema-on-read）-数据的结构是隐含的，只有在数据被读取时才被解释
  * 读时模式类似于编程语言中的动态（运行时）类型检查
* 写时模式（schema-on-write）
  * 写时模式类似于静态（编译时）类型检查
* 模式变更的速度很慢，而且要求停机
  * 大多数关系数据库系统可在几毫秒内执行 ALTER TABLE 语句
  * Mysql执行 ALTER TABLE 时会复制整个表,更改一个大型表时会花费几分钟甚至几个小时的停机时间
    * [mysql8.0.12已优化](https://juejin.cn/post/7111528571532738567) - [Instant Add Column](https://dev.mysql.com/doc/refman/8.0/en/innodb-online-ddl-operations.html)
* 大型表上运行 UPDATE 语句在任何数据库上都可能会很慢
  * 原因-每一行都需要重写
    * 可以将修改之设置为默认值NULL，并在读取时再填充
* 当由于某种原因（例如数据异构）集合中的项目并不都具有相同的结构时，读时模式更具优势
  * 存在许多不同类型的对象，将每种类型的对象放在自己的表中是不现实的
  * 数据的结构由外部系统决定。你无法控制外部系统且它随时可能变化
#### 查询的数据局部性
* 如果应用程序经常需要访问整个文档（例如，将其渲染至网页），那么存储局部性会带来性能优势
* 如果将数据分割到多个表中，则需要进行多次索引查找才能将其全部检索出来，可能导致更多的磁盘I/O查找并花费更多的时间
* 局部性仅仅适用于同时需要文档绝大部分内容的情况
  * 数据库通常需要加载整个文档，即使只访问其中的一小部分，这对于大型文档来说是很浪费的
     * 更新文档时，通常需要整个重写
     * 只有不改变文档大小的修改才可以容易地原地执行
* 通常建议保持相对小的文档，并避免增加文档大小的写入
  * 性能限制了文档数据库的适用场景
* 为了局部性而分组集合相关数据的想法并不局限于文档模型
  * Google 的 Spanner 数据库
  * Oracle - 多表索引集群表
  * Bigtable 数据模型（用于 Cassandra 和 HBase）- 列族
#### 文档和关系数据库的融合
* 关系数据库支持的文档模型
  * xml格式的支持
  * json格式的支持
* 文档数据库支持关系型查询
  * RethinkDB
  * MongoDB 驱动程序可以自动解析数据库引用

## 数据查询语言
### 命令式语言
>  许多常用的编程语言是命令式的
### 声明式查询语言
> SQL,只需指定所需数据的模式 - 结果需满足什么条件，以及如何转换数据（例如，排序，分组和集合），不需要指明如何实现这一目标
* 数据库系统的查询优化器决定使用哪些索引和哪些连接方法，以及以何种顺序执行查询的各个部分
* 比命令式 API 更加简洁和容易
* 隐藏了数据库引擎的实现细节，使得数据库系统可以在不改变查询语句的情况下进行性能提升
* 如果查询用命令式的代码来写的话，那么数据库就永远不可能确定代码是否依赖于排序
* SQL 相当有限的功能性为数据库提供了更多自动优化的空间
* 声明式语言适合并行执行
* Web 上的声明式查询
   * 在 Web 浏览器中，使用声明式 CSS 样式比使用 JavaScript 命令式地操作样式要好得多
   * 在数据库中，使用像 SQL 这样的声明式查询语言比使用命令式查询 API 要好得多
### MapReduce查询
> MapReduce 是一个由 Google 推广的编程模型，用于在多台机器上批量处理大规模的数据
* MapReduce 既不是一个声明式的查询语言，也不是一个完全命令式的查询 API，而是处于两者之间
   * 查询的逻辑用代码片段来表示，这些代码片段会被处理框架重复性调用
* MapReduce 是一个相当底层的编程模型，用于计算机集群上的分布式执行
* 支持通过sql来实现MapReduce查询
   * SQL 中没有任何内容限制它在单个机器上运行

## 图数据模型
> 一个图由两种对象组成：顶点（vertices，也称为 节点，即 nodes，或 实体，即 entities），和 边（edges，也称为 关系，即 relationships，或 弧，即 arcs）。多种数据可以被建模为一个图形
### 举例
* 社交图谱
  * 顶点是人，边指示哪些人彼此认识
* web图
  * 顶点是网页，边缘表示指向其他页面的 HTML 链接
* 公路或铁路网络
  * 顶点是交叉路口，边线代表它们之间的道路或铁路线
### 功能
* 图提供了一种一致的方式，用来在单个数据存储中存储完全不同类型的对象
### 属性图
* 在属性图模型中，每个顶点（vertex）包括
  * 唯一的标识符
  * 出边的集合（outgoing edges）
  * 入边的集合（ingoing edges）
  * 属性的集合（键-值对）
* 每条边（edge）包括
  * 唯一标识符
  * 边的起点（尾部顶点，即 tail vertex）
  * 边的终点（头部顶点，即 head vertex）
  * 描述两个顶点之间关系类型的标签
  * 属性的集合（键-值对）
* 可以将图存储看作由两个关系表组成：一个存储顶点，另一个存储边
* 特点
  * 任何顶点都可以有一条边连接到任何其他顶点。没有模式限制哪种事物可不可以关联
  * 给定任何顶点，可以高效地找到它的入边和出边，从而遍历图，即沿着一系列顶点的路径前后移动
  * 通过对不同类型的关系使用不同的标签，可以在一个图中存储几种不同的信息，同时仍然保持一个清晰的数据模型
### Cypher 查询语言
* Cypher 是属性图的声明式查询语言，为 Neo4j 图形数据库而发明
### SQL 中的图查询
* 可以在关系数据库中表示图数据
*  SQL 查询表示图查询-递归公用表表达式
  * 查询可变长度遍历路径
### 三元组存储和 SPARQL
> 在三元组存储中，所有信息都以非常简单的三部分表示形式存储（主语，谓语，宾语）
* 三元组 (吉姆, 喜欢, 香蕉) 中，吉姆 是主语，喜欢 是谓语（动词），香蕉 是对象
* 三元组的主语相当于图中的一个顶点。而宾语是下面两者之一
  * 原始数据类型中的值，例如字符串或数字。
    * 在这种情况下，三元组的谓语和宾语相当于主语顶点上的属性的键和值
  * 图中的另一个顶点
    * 在这种情况下，谓语是图中的一条边，主语是其尾部顶点，而宾语是其头部顶点
* Turtle 的格式写成三元组
### 语义网
> 从本质上讲，语义网源于一个简单且合理的想法：网站已经将信息发布为文字和图片供人类阅读，为什么不将信息作为机器可读的数据也发布给计算机呢？（基于三元组模型的）资源描述框架（RDF），就是这样的一种机制，允许来自不同网站的数据自动合并成一个数据网络 —— 成为一种互联网范围内的 “通用语义网数据库”（包含所有数据的数据库）
* 三元组存储模型其实是完全独立于语义网存在的
* RDF 数据模型
* SPARQL 查询语言
  * SPARQL 是一种用于三元组存储的面向 RDF 数据模型的查询语言它是 SPARQL 协议和 RDF 查询语言的缩写，发音为 “sparkle”）
### Datalog基础
* Datalog为以后的查询语言提供了基础
* Datalog 的数据模型类似于三元组模式，但进行了一点泛化。把三元组写成 谓语（主语，宾语），而不是写三元语（主语，谓语，宾语）

## 其他数据模型
* 使用基因组数据的研究人员通常需要执行 序列相似性搜索
* 粒子物理学家数十年来一直在进行大数据类型的大规模数据分析（数百 PB 的数据）
* 全文搜索


## NewSql
> NewSQL是一种新方式关系数据库，意在整合RDBMS所提供的ACID事务特性（即原子性、一致性、隔离性和可持久性），以及NoSQL提供的横向可扩展性


