## [事务处理](https://icyfenix.cn/architect-perspective/general-architecture/transaction/)
> 事务处理几乎在每一个信息系统中都会涉及，它存在的意义是为了保证系统中所有的数据都是符合期望的，且相互关联的数据之间不会产生矛盾，即数据状态的一致性
* **四大特性**
  * 原子性 事务中的每个语句（读取、写入、更新或删除数据）都被视为单个单元。要么执行整个语句，要么不执行任何语句
  * 一致性 确保事务仅以预定义的、可预测的方式对表进行更改。事务一致性可确保数据中的损坏或错误不会对表的完整性造成意外后果
  * 隔离性 当多个用户同时从同一个表中读取和写入时，其事务的隔离可确保并发事务不会相互干扰或影响
  * 持久性 确保成功执行的事务对数据所做的更改将被保存，即使在系统出现故障的情况下也是如此
### [本地事务](https://icyfenix.cn/architect-perspective/general-architecture/transaction/local.html)
> 本地事务是指仅操作单一事务资源的、不需要全局事务管理器进行协调的事务
#### 实现原子性和持久性
* 原子性
   * [mysql](https://juejin.cn/post/7055171728514744328)
      * 为了做到同时成功或者失败，当系统发生错误或者执行rollback操作时需要根据undo log 进行回滚
   * [PostgreSQL](https://www.modb.pro/db/37939)
      * MVCC保证原子性
*  持久性
   *  [mysql](https://juejin.cn/post/7055171728514744328)
      * redo log 
   *  PostgreSQL
      * WAL机制
     
### 全局事务
> 全局事务被限定为一种适用于单个服务使用多个数据源场景的事务解决方案
#### XA
> 1991 年，为了解决分布式事务的一致性问题，X/Open组织（后来并入了The Open Group）提出了一套名为X/Open XA（XA 是 eXtended Architecture 的缩写）的处理事务架构，其核心内容是定义了全局的事务管理器（Transaction Manager，用于协调全局事务）和局部的资源管理器（Resource Manager，用于驱动本地事务）之间的通信接口。XA 接口是双向的，能在一个事务管理器和多个资源管理器（Resource Manager）之间形成通信桥梁，通过协调多个数据源的一致动作，实现全局事务的统一提交或者统一回滚
* JTA-基于 XA 模式在 Java 语言中的实现了全局事务处理的标准
   * 事务管理器的接口：javax.transaction.TransactionManager
   * 满足 XA 规范的资源定义接口：javax.transaction.xa.XAResource
#### 2PC-两段式提交
> XA 将事务提交拆分成为两阶段过程
* 准备阶段
  * 在这一阶段，协调者询问事务的所有参与者是否准备好提交，参与者如果已经准备好提交则回复 Prepared，否则回复 Non-Prepared
* 提交阶段
  * 协调者如果在上一阶段收到所有事务参与者回复的 Prepared 消息，则先自己在本地持久化事务状态为 Commit，在此操作完成后向所有参与者发送 Commit 指令，所有参与者立即执行提交操作；否则，任意一个参与者回复了 Non-Prepared 消息，或任意一个参与者超时未回复，协调者将自己的事务状态持久化为 Abort 之后，向所有参与者发送 Abort 指令，参与者立即执行回滚操作
* 两段式提交缺点
  * 单点问题
      * 协调者在两段提交中具有举足轻重的作用，协调者等待参与者回复时可以有超时机制，允许参与者宕机，但参与者等待协调者指令时无法做超时处理。一旦宕机的不是其中某个参与者，而是协调者的话，所有参与者都会受到影响。如果协调者一直没有恢复，没有正常         发送 Commit 或者 Rollback 的指令，那所有参与者都必须一直等待
  * 性能问题
      * 两段提交过程中，所有参与者相当于被绑定成为一个统一调度的整体，期间要经过两次远程服务调用，三次数据持久化（准备阶段写重做日志，协调者做状态持久化，提交阶段在日志写入 Commit Record），整个过程将持续到参与者集群中最慢的那一个处理操作结  
        束为止，这决定了两段式提交的性能通常都较差
  * 一致性风险
     * 当网络稳定性和宕机恢复能力的假设不成立时，仍可能出现一致性问题
#### 3PC-三阶段提交
>  为了缓解两段式提交协议的一部分缺陷，具体地说是协调者的单点问题和准备阶段的性能问题
* CanCommit
* PreCommit
* DoCommit
### 共享事务
### 分布式事务
