## 主要数据结构
* 查询树 SQL语句的语法分析后的形式
* 关系对象。在连接过程中表示表对象的数据结构，和表的逻辑定义不同，只用于查询优化器阶段
* 连接相关的对象。表示连接操作的相关数据结构，包括限定连接条件的结构体、表示连接类型的枚举值、表示连接结果的路径结构体等
* 查询执行计划。表示查询语句如何执行的“计划”，包括了代价最小的连接路径、不同类型的物理操作结点等
## 基本数据结构
* 链表
  * 链表（List）是PostgreSQL提供的一个抽象的数据结构，用以存放各种对象，把多个对象组织成一个顺序的链表。但同一个List中存放的是同一类对象
* 结点和结点标识
  * 结点（Node）是PostgreSQL提供的一个抽象的数据结构的头部结构，用以表示各种对象。PostgreSQL在一棵查询树上用结点这样一个数据结构标识了不同的各种各样的对象，然后根据结点标识区分是哪种对象
* 命令类型
  * 命令类型（CmdType）是PostgreSQL提供的一个标识SQL语句类型的枚举结构。PostgreSQL在语法分析阶段和查询优化阶段多使用命令类型，需要针对不同SQL语句的类型采取不同的处理方式

  ![image](https://github.com/jsjchai/study-notes/assets/13389058/7a7850ad-6bde-4fdf-9de6-7f0bdac74ffb)

### 查询树
> 查询树（Query）又称语法分析树，SQL语法分析模块对文本类型的SQL语句进行词法分析和语法分析后，得到的语法树。语法分析用于检查SQL语句的语法（格式）是否正确，把SQL语句按语法进行格式分解（PG的语法规则参见src/backend/parser/gram.y文件）即可转化为查询树

> 初步得到的查询树，还将进行语义处理。语义处理是检查SQL语句中的对象是否符合数据库的用户模式（如表定义）以及对象表达的意义是否有效（如对一个数值型列做LIKE操作是无意义的）等

> 查询语句通过语法分析器形成查询树传给查询优化器的planner函数进行优化。查询优化器的入口函数planner的参数即是一棵查询树

### 各种对象的结构
* 范围表
  *  范围表（RangeTblEntry）是Query结构体的一个成员（List*rtable），是在语法分析模块SQL查询语句解析后，得到的查询对象的信息
* 关系优化信息
  *  关系优化信息（RelOptInfo结构体）是PlannerInfo结构体的两个成员（simple_rel_array和join_rel_list），是查询优化器在优化阶段的操作对象，其值对应的类型可以是普通的关系、子查询的输出结果、函数、索引，或者是连接的输出结果等，可以把这些类型认为是一个虚拟的“关系”
* 索引
  * 5种索引类型，分别是btree、hash、gist、gin、spgist
  * btree索引支持amgettuple、amgetbitmap函数，其函数名称分别是btgettuple、btgetbitmap
  * 从代码中可以查阅btgettuple、btgetbitmap这两个函数的功能，其基本含义是，利用索引（如btree索引）如何获得对应的元组（单个或多个元组）
  * pg_am系统表实则是一个函数注册表，PostgreSQL支持的索引以及索引实现其功能时需要使用的函数都定义在了这个表中。此表的元数据就是索引对象的接口，抽象了索引的属性和动作，此表的元组就是具体对象的定义
* 范围表和关系优化信息对比
  * 范围表和关系优化信息都用以表达被查询对象

  ![image](https://github.com/jsjchai/study-notes/assets/13389058/24cb9fc9-2e9f-4c6d-b1cc-445bc811fefc)

### 连接操作相关的结构
> 连接操作（Join）是查询语句的基本操作，PostgreSQL提供了约束条件、特定连接信息、路径、路径排序、连接类型等结构体表示与连接相关的信息
* 约束条件
  * 约束条件（RestrictInfo）是指WHERE、JOIN/ON、HAVING子句中的谓词（PostgreSQL在代码中常用restrictions、join clauses、quals等表示）
    * 限制条件
    * 连接条件
* 特定连接信息
  * 特定连接信息（SpecialJoinInfo）标识了连接操作的相关信息
  * PostgreSQL在处理连接语义的时候，除了使用约束条件外，还使用了SpecialJoinInfo结构体标识连接语义，包括内连接、左外连接、右外连接、全外连接、半连接、反半连接
* 路径
  * 路径（Path）代表了SELECT语句的FROM和WHERE/HAVING等子句的对象（表、子查询、连接后生成的新关系等）与单个对象的访问方式（单表访问方式）、对象间的连接方式（两表间的连接方式）、所有对象间的连接顺序（多表间的连接顺序）最终组合成的一个多表连接方式的过程和过程执行的花费
  * 在PostgreSQL中，路径的形态是一颗二叉树，树上有各种结点。路径使用一个结构体描述，这个结构体表明一条路径的花费（cost）和路径排序（PathKey）的情况这个结构体构成一个list，作为一个关系（RelOptInfo结构体）的子部分，被存储在一个关系优化信息结构体上，用以表明形成这个关系的各种路径
* 路径排序
  * 路径排序（PathKey）用以表示在一个Path的形成过程中是如何进行排序操作的。排序的依据在EquivalenceClass*pk_eclass中定义
* 连接类型
  *  连接类型（JoinType）是一个枚举类型，定义了PostgreSQL支持的连接操作的连接类型，包括内连接、左外连接、右外连接、全外连接、半连接、反半连接
* 连接路径
  *  连接路径（JoinPath）是路径的一种形式，表示在某个路径中的当前结点的操作方式是连接操作
### 查询执行计划相关的结构
* 计划结点
  * 计划（Plan）表示SQL查询语句的执行方案，即一条查询语句是如何执行的
* 扫描结点
  * 扫描（Scan）结点是计划的一部分，通常属于计划树的叶子结点，用于完成单表的数据获取
* 连接结点
  * 连接（Join）结点表示连接算法操作，用于支持连接操作，即表示表与表如何进行连接。PostgreSQL支持3种两表连接的算法，分别是嵌套循环连接（NestLoop）、归并连接（MergeJoin）和Hash连接（HashJoin）
* 计划信息结点
  * 计划信息（PlannerInfo）是查询生成的全局查询执行计划的相关信息，存放在PlannerInfo结构体中，这是一个总控的root式的结构
* 计划执行结点
  * 计划执行结点（PlannedStmt），表示被执行器执行的与查询执行计划相关的信息
## 各个阶段间和主要结构体间的关系

![image](https://github.com/jsjchai/study-notes/assets/13389058/b84fbd02-d02b-4672-b756-de580c09ef33)

## 各个阶段间和主要结构体间的关系

![image](https://github.com/jsjchai/study-notes/assets/13389058/bde3433c-b6ac-4686-9be1-faaef7a20081)



