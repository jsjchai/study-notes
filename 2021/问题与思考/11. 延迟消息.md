## 延迟消息
### 背景
> 很多时候，业务有“在一段时间之后，完成一个工作任务”的需求.比如: 预约挂号,患者在预约挂号成功后,需要提前一段时间提醒患者看病就诊
### 方案
#### redis key过期通知
1. 修改redis配置文件,在redis.conf文件开启notify-keyspace-events Ex
2. 配置redis监听器
```java
 @Autowired
 private RedisConnectionFactory connectionFactory;
 @Bean
 public RedisMessageListenerContainer listenerContainer(){
     RedisMessageListenerContainer listenerContainer = new RedisMessageListenerContainer();
     listenerContainer.setConnectionFactory(connectionFactory);
     return listenerContainer;
 }

@Component
@Slf4j
public class RedisMessageListener extends KeyExpirationEventMessageListener {

    /**
     * Creates new {@link MessageListener} for {@code __keyevent@*__:expired} messages.
     *
     * @param listenerContainer must not be {@literal null}.
     */
    public RedisMessageListener(RedisMessageListenerContainer listenerContainer) {
        super(listenerContainer);
    }
    
    @Override
    public void onMessage(Message message, byte[] pattern) {
        String key = new String(message.getBody(), StandardCharsets.UTF_8);
        String channel = new String(message.getChannel(), StandardCharsets.UTF_8);
        String patternStr = new String(pattern, StandardCharsets.UTF_8);
        log.info("key:{},channel:{},pattern:{}", key, channel, patternStr);
    }
}
```

### 参考文档
* [延迟任务场景技术选型](https://note.dolyw.com/distributed/25-Delay-Task.html)
* [6种延时队列的实现方案](https://segmentfault.com/a/1190000022718540)
